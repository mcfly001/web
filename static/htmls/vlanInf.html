<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="../js/default.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="main">
            <div class="choose_area">
                <ol class="ol_tag clear">
                    <li><a data-key="set_vlan" href="vlanInf.html" class="selected">设置vlan</a></li>
                    <li><a data-key="vlan_binding" id="vlan_set" href="vlanSet.html">vlan绑定</a></li>
                </ol>
            </div>
            <div class="top-button">
                <button data-key="add" id="Tadd">添加</button>
            </div>
            <!-- 背景 -->
            <div class="div-bgd">
                <div class="div-bgd1">
                    <div class="div-bgd2"></div>
                </div>
            </div>
            <div class="addf" id="addf" style="display: none;">
                <div data-key="disable" id="addf-head" class="addf-head"><a href="#" class="close" id="close">关闭</a></div>
                <div class="addf-cont">
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label for="" class="addf-line-le">vlan ID：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="vlan_id" class="form-control">
                        </div>
                        <div class="addf-line-rig"><span class="hints">(3~4094)</span></div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="vlan_ifnames" for="" class="addf-line-le">vlan接口名称：</label>
                        <div class="addf-line-mid">
                            <input disabled="disabled" id="vlan_name" type="text" class="form-control">
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="ipv4_address" for="" class="addf-line-le">ipv4地址：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="ipv4_addr" class="form-control">
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="subnet_mask_ipv4" for="" class="addf-line-le">ipv4子网掩码：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="ipv4_mask" class="form-control">
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line dhcp_switch">
                        <div class="clear"></div>
                        <label data-key="dhcp_switch" for="" class="addf-line-le">DHCP开关：</label>
                        <div class="addf-line-mid">
                            <input type="checkbox" checked id="dhcpswitch">
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line dhcp_vlan">
                        <div class="clear"></div>
                        <label data-key="start_address" for="" class="addf-line-le">起始地址：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="start_addr" class="form-control">
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line dhcp_vlan">
                        <div class="clear"></div>
                        <label data-key="end_address" for="" class="addf-line-le">结束地址：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="end_addr" class="form-control">
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line dhcp_vlan">
                        <div class="clear"></div>
                        <label data-key="lease_times" for="" class="addf-line-le">租用时间：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="lease_time" class="form-control">
                        </div>
                        <div class="addf-line-rig">
                            <span data-key="minute" class="hints">分钟</span>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line dhcp_vlan">
                        <div class="clear"></div>
                        <label for="" class="addf-line-le">DHCP-OPTION：</label>
                        <div class="addf-line-mid" id="inputPar">
                            <input type="text" class="form-control" id="dhcpoptions0">
                        </div>
                        <div class="addf-line-rig" id="del"></div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line dhcp_vlan">
                        <div class="clear"></div>
                        <label for="" class="addf-line-le"></label>
                        <div class="addf-line-mid">
                            <span data-key="formats" class="hints">格式：1,12.0.2.3</span>
                        </div>
                        <div class="addf-line-rig">
                            <button data-key="add" onclick="addOption('inputPar', 'del', 'dhcpoptions0')">增加</button>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
                <div class="addf-foot">
                    <button data-key="apply" class="sure">确定</button>
                    <button data-key="cancle" class="cansel">取消</button>
                </div>
            </div>
            <table id="table" class="display" cellpadding="0" cellspacing="0">
                <thead>
                    <tr class="tab-th">
                        <th data-key="number">序号</th>
                        <th data-key="vlan_ifname">vlan接口名称</th>
                        <th data-key="add">vlan id</th>
                        <th data-key="ipv4_addres">ipv4地址</th>
                        <th data-key="subnet_maskipv4">ipv4子网掩码</th>
                        <th data-key="dhcp_switch">dhcp开关</th>
                        <th data-key="act">动作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th></th>
                        <th>vlan1</th>
                        <th>1</th>
                        <th>123.25.30.2</th>
                        <th>255.0.0.0</th>
                        <th data-key="on">开</th>
                        <th><a data-key="modify" href="#" class="edit">修改</a> | <a data-key="delete" href="#" class="delete">删除</a></th>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
<script>
var net = sessionStorage.getItem("netbridge");
if (net == 1) {
    $("#vlan_set").css("display", "none");
}
$("#dhcpswitch").click(function() {
    if ($("#dhcpswitch").prop("checked") == true) {
        $(".dhcp_vlan").css("display", "block");
    } else {
        $(".dhcp_vlan").css("display", "none");
    }
});

function lastChangeNext(id1, id2) {
    $("#" + id1).change(function() {
        $("#" + id2).val("vlan" + $("#" + id1).val())
    })
}

//每次刷新页面时，返回的列表数据主体，存在此变量中，它也是datatables初始化时的真正数据源
var real_data = {},
    index,
    count = 0;
$(document).ready(function() {
    real_data = get_real_data("vlan_interface");
    var otable = $("#table").DataTable({
        "data": real_data,
        "columns": [{
                "data": null,
                "searchable": false,
                "orderable": false
            },
            {
                "data": "vlanname"
            },
            { "data": "vlanId" },
            {
                "data": "ipaddr",
                render: function(data, type, row, meta) {
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": "netmask",
                render: function(data, type, row, meta) {
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": "enable",
                render: function(data, type, row, meta) {
                    if (data == "0") {
                        return '<span>' + allResources['off'][g_lang] + '</span>'
                    } else if (data = "1") {
                        return '<span>' + allResources['on'][g_lang] + '</span>'
                    }
                }
            },
            {
                "data": null,
                "searchable": false,
                "orderable": false,
                render: function() {
                    count++;
                    return '<th><a href="#" class="edit ' + count + 'tn">' + allResources['modify'][g_lang] + '</a> | <a href="#" class="delete">' + allResources['delete'][g_lang] + '</a></th>'
                }
            }
        ],
        "order": [
            [1, "asc"]
        ],
        "lengthMenu": [10, 30],
        "pagingType": "full_numbers",
        'fnDrawCallback': function() {
            var newnode = creGoPage("changePage1", "dataTable-btn-1");

            document.getElementById("table_paginate").appendChild(newnode);
            //必须重新取得表格的datatable初始化对象，再用它调用其翻页函数，否则不会生效翻页
            var ooTable = $("#table").dataTable();
            $('#dataTable-btn-1').click(function(e) {
                if ($("#changePage1").val() && $("#changePage1").val() > 0) {
                    var redirectpage = $("#changePage1").val() - 1;
                } else {
                    var redirectpage = 0;
                }
                ooTable.fnPageChange(redirectpage);
            });
        },
        language: { //多语言
            "url": lang_url
        },
        "dom": "lftip"
    });
    //序号列
    otable.on('order.dt search.dt',
        function() {
            otable.column(0, {
                search: 'applied',
                order: 'applied'
            }).nodes().each(function(cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();

    //页面弹窗
    function showAddf(vlan_id, ipv4_addr, ipv4_mask, dswitch, start_addr, end_addr, lease_time, dhcpoption) {
        showDiv([".addf", ".div-bgd"]);
        if (vlan_id == undefined) {
            $("#vlan_name").val("");
        } else {
            $("#vlan_name").val("vlan" + vlan_id);
        }
        if (dswitch == 0) {
            $(".dhcp_vlan").css("display", "none");
        }else {
            $(".dhcp_vlan").css("display", "");
        }
        $("#vlan_id").val(vlan_id);
        $("#ipv4_addr").val(ipv4_addr);
        $("#ipv4_mask").val(ipv4_mask);
        if (dswitch != undefined) {
            $("#dhcpswitch").prop("checked", parseInt(dswitch));
        }else {
            $("#dhcpswitch").prop("checked", true);
        }
        $("#start_addr").val(start_addr);
        $("#end_addr").val(end_addr);
        $("#lease_time").val(lease_time);
        if (dhcpoption != undefined) {
            var option = dhcpoption + "";
            var option_length = option.split(" ");
            $("#inputPar").html("");
            $("#del").html("");
            $("#inputPar").append('<input type="text" class="form-control" id="dhcpoptions0">');
            for (var i = 0; i < option_length.length; i++) {
                var m = i + 1;
                $("#dhcpoptions0").before('<input type="text" class="form-control" id="dhcpoption0' + m + '" value="' + option_length[i] + '">');
                var k = i + 2;
                $("#del").append('<button class="btn-danger btn" onclick="delOption(this,\'dhcpoption0\')" id="' + k + 'dels">删除</button>');
            };
        }else {
            $("#inputPar").html("");
            $("#del").html("");
            $("#inputPar").append('<input type="text" class="form-control" id="dhcpoptions0">');
        }
        if (sessionStorage.getItem("netbridge") == 1) {
            $("#dhcpswitch").prop("checked", false);
            $(".dhcp_switch").css("display", "none");
            $(".dhcp_vlan").css("display", "none");
        }
    };
    //index即编辑的数据在真正数据源中所处数组的索引 
    $(".edit").click(function() {
        action = "modify";
        var class_num = $(this).attr("class");
        index = parseInt(class_num.substr(4)) - 1;
        var leasetime = real_data[index].leasetime == undefined ? "" : parseInt(real_data[index].leasetime);
        showAddf(real_data[index].vlanId, real_data[index].ipaddr, real_data[index].netmask, real_data[index].enable, real_data[index].start, real_data[index].end, leasetime, real_data[index].dhcp_option);
        $("#vlan_id").prop("disabled", "disabled");
    });
    $("#Tadd").click(function() {
        action = "add";
        showDiv([".addf", ".div-bgd"]);
        $("#vlan_id").prop("disabled", "");
        showAddf();
    });

    $(".delete").click(function() {
        action = "delete";
        var class_num = $(this).parent().find(".edit").attr("class");
        index = parseInt(class_num.substr(4)) - 1;
        var vlanname = real_data[index].vlanname,
            vlanId = real_data[index].vlanId;
        
        //获取已被绑定的vlan接口的pvid
        var pvid_arr = [];
        $.ajax({
            url: url_host + "vlan_trunk&action=read",
            type: 'GET',
            async: false,  
            success: function(data) {
                if (data.result.code == 0) {
                    var real_data = data.result.data;
                    for(var i=0;i<real_data.length;i++){
                        pvid_arr.push(real_data[i].pvid);
                    }
                } else {
                    console.log("code is not 0");
                }
            }
        }); 

        for(var i=0;i<pvid_arr.length;i++){
            if(pvid_arr[i] == vlanId){
                alert(vlanname + allResources['donot_del_if'][g_lang]);
                return false;
            }
        } 
        $.ajax({
            url: url_host + "vlan_interface&action=" + action + "&vlanname=" + vlanname + "&vlanId=" + vlanId + url_time,
            type: 'GET',
            async: false,   //发送同步请求
            contentType: 'application/json',
            beforeSend: function() {
                var href = window.location.href,
                    page_href;
                if (href[href.length - 1] == "#") {
                    page_href = href.substring(0, href.length - 1)
                } else {
                    page_href = href
                }
                sessionStorage.setItem("main_frame", page_href);
                lang_alert('del_suc_wait');
                location.href = "net_wait_page.html";
            },
            success: function(data) {

            },
            error: function() {}
        })
    })
})

//action根据增加、删除的不同予以更改
var action = "";
lastChangeNext("vlan_id", "vlan_name");
$(".sure").click(function() {
    var vlanId = $("#vlan_id").val(),
        vlanname = "vlan" + vlanId,
        ifname = "eth1." + vlanId,
        ipaddr = $("#ipv4_addr").val(),
        netmask = $("#ipv4_mask").val(),
        enable = ($("#dhcpswitch").prop("checked") == true) ? 1 : 0,
        start = $("#start_addr").val(),
        end = $("#end_addr").val(),
        leasetime = ($("#lease_time").val() == "") ? "" : ($("#lease_time").val() + "m"),
        dhcp_option = "";
    var dhcp_lgh = $("#inputPar input");
    for (var i = 0; i < dhcp_lgh.length; i++) {
        if (dhcp_lgh[i].value != "") {
                var option_check = dhcp_lgh[i].value.split(",");
                if (!IsNum(option_check[0]) || option_check[0] == 0) {
                    lang_alert('dhcp_opt_novalid')
                    return false;
                }
                if (!IsIp(option_check[1])) {
                    lang_alert('dhcp_opt_novalid')
                    return false;
                }
            }
        dhcp_option = dhcp_option + dhcp_lgh[i].value + " ";
    };
	
    //数据校验
    console.log("vlanname :",vlanname,"   vlanId :",vlanId,"  ipaddr :",ipaddr,"  netmask :",netmask);
    console.log("enable :",enable,"  start :",start,"  end :",end,"  leasetime :",leasetime);
    if(vlanId == "") {
        lang_alert('vlanid_empty');
        return false;
    }
    if(!IsNum(vlanId) || vlanId<3 || vlanId>4094){
        lang_alert('vlanid_novalid');
        return false;
    }
    if(action == "add"){
        for(var i=0;i<real_data.length;i++){
            if(real_data[i].vlanId == vlanId){
                lang_alert('vlanid_exist');
                return false;
            }
        }
    }
    if(ipaddr == "" || netmask == ""){
        lang_alert('ipv4_mask_empty');
        return false
    }
    if(!IsIp(ipaddr)){
        lang_alert('ipv4_novalid');
        return false;
    }
    if(!IsMask(netmask)){
        lang_alert('ipv4_mask_novalid');
        return false;
    }
    if(enable == 1){
        if(start == "" || end == "" || leasetime == "" || dhcp_option == ""){
            lang_alert('conf_all');
            return false;
        }
    }
    if(start != "" && end != ""){
        if(!IsIp(start)){
            lang_alert('start_address_novalid');
            return false;
        }
        if(IsEqualIPAddress(ipaddr,start,netmask) == false){
            lang_alert('start_not_same_lan');
            return false;
        }
        if(!IsIp(end)){
            lang_alert('end_address_novalid');
            return false;
        }
        if(IsEqualIPAddress(ipaddr,end,netmask) == false){
            lang_alert('end_not_same_vlan');
            return false;
        }
        if(IptoNum(end) < IptoNum(start)){
            lang_alert('end_less_start');
            return false;
        }
    } 
    if(leasetime != "" && (!IsNum($("#lease_time").val()) || $("#lease_time").val()<5 || $("#lease_time").val()>720)){
        lang_alert('lease_time_novalid');
        return false;
    }
    //vlan 添加、删除、修改 都会致使网络重启，从而导致当下接口请求终端，一直拿不到返回消息，故而直接跳转至等待页，等待页周期请求上一页面接口，成功返回则返回上一页面。
    $.ajax({
        url: '../../cgi-bin/common.cgi?luaname=vlan_interface&action=' + action + '&vlanId=' + vlanId + '&vlanname=' + vlanname + "&ipaddr=" + ipaddr + "&netmask=" + netmask + "&enable=" + enable + "&start=" + start + "&end=" + end + "&leasetime=" + leasetime + "&dhcp_option=" + dhcp_option + "&ifname=" + ifname + url_time,
        type: 'GET',
        async: false,   //发送同步请求
        contentType: 'application/json',
        beforeSend: function() {
            var href = window.location.href,
                page_href;
            if (href[href.length - 1] == "#") {
                page_href = href.substring(0, href.length - 1)
            } else {
                page_href = href
            }
            sessionStorage.setItem("main_frame", page_href);
            lang_alert('add_succ_wait');
            location.href = "net_wait_page.html";
        },
        success: function(data) {

        },
        error: function() {}
    })
})
</script>

</html>