<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>dhcp</title>
    <script src="../js/default.js"></script>
    <style>
    table {
        text-align: center;
    }
    select#dhcp-ser-sea-op {
        width: .8rem;
        min-width: 85px;
    }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- table caption -->
        <div class="choose_area">
            <ol class="ol_tag clear">
                <li><a data-key="dhcp_server" href="dhcpSer.html" class="selected">DHCP服务器</a></li>
                <li><a data-key="dhcp_list" href="dhcpList.html">DHCP列表</a></li>
                <li><a data-key="static_ip_ass" href="dhcpStat.html">静态地址分配</a></li>
            </ol>
        </div>
        <div class="dhcp-ser-wrapper wra">
            <!-- dhcp table-tool -->
            <div class="table-tool">
                <div class="filter_menu">
                    <ul class="ulplace clear">
                        <li>
                            <span data-key="search_opt">搜索选项</span>
                            <select name="" id="dhcp-ser-sea-op">
                                <option data-key="dhcp_status" value="1">DHCP状态</option>
                                <option data-key="ifname" value="2">接口名称</option>
                            </select>
                        </li>
                        <li><span data-key="search_content">搜索内容 </span>
                            <input type="text" id="dhcp-ser-sea-con">
                        </li>
                        <li>
                            <button data-key="search" id="dhcp-ser-sea">搜索</button>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- 页面弹窗 -->
            <!-- 悬浮背景 -->
            <div class="div-bgd">
                <div class="div-bgd1">
                    <div class="div-bgd2"></div>
                </div>
            </div>
            <!-- 修改 -->
            <div class="addf" id="addf" style="display: none;">
                <div class="addf-head" id="addf-head">
                    <a data-key="close" href="javascript:void(0);" id="close" class="close">关闭</a>
                </div>
                <div class="dhcp-ser-swi">
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label for="aname" class="addf-line-le">DHCP：</label>
                        <div class="addf-line-mid">
                            <input type="checkbox" checked="checked" id="dhcpswitchs" onclick="swi()" />
                        </div>
                        <div class="addf-line-rig">
                            <span data-key="dhcp_switch" class="hints">开启/关闭DHCP</span>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
                <div class="addf-cont">
                    <div class="addf-line" style="display: none">
                        <div class="clear"></div>
                        <label data-key="reference" for="quote" class="addf-line-le">引用：</label>
                        <div class="addf-line-mid">
                            <input type="text" disabled="disabled" id="quote" class="form-control"></input>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="if_ip" for="quote" class="addf-line-le">接口IP：</label>
                        <div class="addf-line-mid">
                            <span id="ipaddr"></span>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="subnet_mask" for="quote" class="addf-line-le">子网掩码：</label>
                        <div class="addf-line-mid">
                            <span id="netmask"></span>
                        </div>
                        <div class="clear"></div>
                    </div>

                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="start_address" for="startip" class="addf-line-le">起始地址：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="startip" class="form-control" />
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="end_address" for="endip" class="addf-line-le">结束地址：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="endip" class="form-control" />
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label data-key="lease_times" for="renttime" class="addf-line-le">租用时间：</label>
                        <div class="addf-line-mid">
                            <input type="text" id="renttime" class="form-control" />
                        </div>
                        <div class="addf-line-rig">
                            <span data-key="minute" class="hints">分钟</span>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label class="addf-line-le">DHCP-OPTIONS: </label>
                        <div class="addf-line-mid" id="inputPar">
                            <input type="text" class="form-control" id="dhcpoptions0">
                        </div>
                        <div class="addf-line-rig" id="del"></div>
                        <div class="clear"></div>
                    </div>
                    <div class="addf-line">
                        <div class="clear"></div>
                        <label class="addf-line-le"></label>
                        <div class="addf-line-mid">
                            <p data-key="formats" class="hints">格式：1,12.0.2.3</p>
                        </div>
                        <div class="addf-line-rig">
                            <button data-key="add" class="btn btn-add" onclick="addOption('inputPar', 'del', 'dhcpoptions0')">增加</button>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
                <div class="addf-foot">
                    <button data-key="apply" class="btn-save btn sure ed_sure">确定</button>
                    <button data-key="cancle" class="btn-danger btn cansel">取消</button>
                </div>
            </div>
            <!-- table内容 -->
            <table id="dhcp-ser" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr class="tab-th">
                        <th data-key="number">序号</th>
                        <th data-key="enable_dhcp">DHCP开启</th>
                        <th data-key="ifname">接口名称</th>
                        <th data-key="start_addres">起始地址</th>
                        <th data-key="end_addres">结束地址</th>
                        <th data-key="lease_time">租用时间（分钟）</th>
                        <th data-key="act">动作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td></td>
                        <td data-key="on">开</td>
                        <td>lan</td>
                        <td>1.1.1.1</td>
                        <td>3.3.3.3</td>
                        <td>125</td>
                        <td>
                            <a data-key="modify" href="javascript:void(0);" class="edit0">修改</a>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td data-key="on">关</td>
                        <td>wan</td>
                        <td>1.1.1.1</td>
                        <td>3.3.3.3</td>
                        <td>125</td>
                        <td>
                            <a data-key="modify" href="javascript:void(0);" class="edit0">修改</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
<script>
function swi() {
    if ($("#dhcpswitchs").prop("checked") == true) {
        showDiv([".addf-cont"]);
    } else {
        hideDiv([".addf-cont"]);
    }
}

var real_data = {},
    count = 0;
$(document).ready(function() {
    real_data = get_real_data("dhcp_server");
    var tableser = $("#dhcp-ser").DataTable({
        "data": real_data,
        "columns": [{
            "searchable": false,
                "orderable": false,
                "data": null
            },
            {
                "data": "enable",
                render: function(data, type, row, meta) {
                    if (data == "0") {
                        return '<span>' + allResources['off'][g_lang] + '</span>'
                    } else if (data = "1") {
                        return '<span>' + allResources['on'][g_lang] + '</span>'
                    }
                }
            },
            {
                "data": "interface",
                render: function(data, type, row, meta){
                    return row == undefined ? "" :
                           ((row.interface == undefined ? "" : row.interface) + ":"
                          + (row.ipaddr == undefined ? "" : row.ipaddr));
                }

            },
            {
                "data": "start",
                render: function(data, type, row, meta) {
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": "end",
                render: function(data, type, row, meta) {
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": "leasetime",
                render: function(data, type, row, meta) {
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return '<span>' + parseInt(data) + '</span>';
                    }
                }
            },
            {
                "data": null,
                "searchable": false,
                "orderable": false,
                render: function() {
                    count++;
                    return '<th><a href="#" class="edit ' + count + 'tn">' + allResources['modify'][g_lang] + '</a></th>'
                }
            }

        ],
        "lengthMenu": [ 10, 30],
        "pagingType": "full_numbers",
        "order": [1, "asc"],
        'fnDrawCallback': function(table) { //跳转指定页
            var newnode = creGoPage("changePageSer", "dataTable-btn-ser");
            document.getElementById("dhcp-ser_paginate").appendChild(newnode);
            var oTable = $("#dhcp-ser").dataTable();
            $('#dataTable-btn-ser').click(function(e) {
                if ($("#changePageSer").val() && $("#changePageSer").val() > 0) {
                    console.log($("#changePageSer").val());
                    var redirectpage = $("#changePageSer").val() - 1;
                } else {
                    var redirectpage = 0;
                }
                oTable.fnPageChange(redirectpage);
            });
        },
        language: { //多语言
            "url": lang_url
        }
    });
    //序号列
    tableser.on('order.dt search.dt',
        function() {
            tableser.column(0, {
                search: 'applied',
                order: 'applied'
            }).nodes().each(function(cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();
    //自定义搜索
    $("#dhcp-ser-sea").click(function(event) {
        var sea_op = $("#dhcp-ser-sea-op").val();
        var sea_con = $("#dhcp-ser-sea-con").val();
        tableser
            .column(sea_op)
            .search(sea_con)
            .draw();
    });
    //展示全部
    // $("#display-all").click(function() {
    //     tableser.ajax.reload().draw();
    // });
    //页面弹窗
    function showAddf(switchs, quote, ipaddr, netmask, startip, endip, leasetime, dhcpoption) {
        $("#dhcpswitchs").prop("checked", parseInt(switchs));
        $("#quote").val(quote);
        $("#ipaddr").text(ipaddr);
        $("#netmask").text(netmask);
        $("#startip").val(startip);
        $("#endip").val(endip);
        $("#renttime").val(leasetime);
        if (dhcpoption != undefined) {
            var option = dhcpoption + "";
            var option_length = option.split(" ");
            $("#inputPar").html("");
            $("#del").html("");
            $("#inputPar").append('<input type="text" class="form-control" id="dhcpoptions0">');
            for (var i = 0; i < option_length.length; i++) {
                var m = i + 1;
                $("#dhcpoptions0").before('<input type="text" class="form-control" id="dhcpoption0' + m + '" value="' + option_length[i] + '">');
                var k = i + 2;
                $("#del").append('<button class="btn-danger btn" onclick="delOption(this,\'dhcpoption0\')" id="' + k + 'dels">' + allResources['delete'][g_lang] + '</button>');
            };
        }else {
            $("#inputPar").html("");
            $("#del").html("");
            $("#inputPar").append('<input type="text" class="form-control" id="dhcpoptions0">');
        }
    };

    $(".edit").click(function() {
        showDiv([".div-bgd", "#addf"]);
        var data = tableser.row($(this).parents("tr")).data(),
            leasetime = (data.leasetime == "" || data.leasetime == undefined) ? "" : parseInt(data.leasetime);
        showAddf(data.enable, data.interface, data.ipaddr, data.netmask, data.start, data.end, leasetime, data.dhcp_option);
    });

    $(".close").click(function() {
        hideDiv([".div-bgd", "#addf"]);
    });
    $(".cansel").click(function() {
        hideDiv([".div-bgd", "#addf"]);
    });

     $(".ed_sure").click(function() {
         var enable = $("#dhcpswitchs").prop("checked") ? 1 : 0,
             interface = $("#quote").val(),
             ipaddr = $("#ipaddr").html(),
             netmask = $("#netmask").html(),
             start = $("#startip").val(),
             end = $("#endip").val(),
             leasetime = ($("#renttime").val() == "") ? "" : ($("#renttime").val() + "m"),
             dhcp_option = "",
             dhcp_lgh = $("#inputPar input"),
             url = "";
         for (var i = 0; i < dhcp_lgh.length; i++) {
            if (dhcp_lgh[i].value != "") {
                var option_check = dhcp_lgh[i].value.split(",");
                if (!IsNum(option_check[0]) || option_check[0] == 0) {
                    lang_alert('dhcp_opt_novalid')
                    return false;
                }
                if (!IsIp(option_check[1])) {
                    lang_alert('dhcp_opt_novalid')
                    return false;
                }
            }
             dhcp_option = dhcp_option + dhcp_lgh[i].value + " ";
         }

         //数据校验
         if(enable == 1){
             if(start == "" || end == "" || leasetime == ""){
                 lang_alert('conf_all');
                 return false;
             }
         }
         if(start != "" && end != ""){
             if(!IsIp(start)){
                 lang_alert('start_address_novalid');
                 return false;
             }
             if(IsEqualIPAddress(ipaddr,start,netmask) == false){
                lang_alert('start_not_same_lan');
                return false;
             }
             if(!IsIp(end)){
                 lang_alert('end_address_novalid');
                 return false;
             }
             if(IsEqualIPAddress(ipaddr,end,netmask) == false){
                lang_alert('end_not_same_lan');
                return false;
             }
             if(IptoNum(end) < IptoNum(start)){
                 lang_alert('end_less_start');
                 return false;
             }
         }
         if( leasetime != "" && (!IsNum($("#renttime").val()) || $("#renttime").val()<5 || $("#renttime").val()>720)){
             lang_alert('lease_time_novalid');
             return false;
         }
         url = url_host + "dhcp_server&action=modify&enable=" + enable + "&interface=" + interface
             + "&start=" + start + "&end=" + end + "&leasetime=" + leasetime + "&dhcp_option=" + dhcp_option + url_time;
         check_code0(url);
     });
})
</script>

</html>
