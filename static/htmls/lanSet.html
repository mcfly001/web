<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="../js/default.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="choose_area">
            <ol class="ol_tag clear">
                <li><a data-key="lan_setting" href="#" class="selected">LAN口设置</a></li>
            </ol>
        </div>
        <div class="line">
            <div class="clear"></div>
            <div class="le">
                <span data-key="ip_address">IP地址：</span>
            </div>
            <div class="mid">
                <input type="text" class="form-control" id="ipaddr">
            </div>
            <div class="rig">
                <button data-key="apply" class="" id="Tsave">保存</button>
            </div>
            <div class="clear"></div>
        </div>
        <div class="line">
            <div class="clear"></div>
            <div class="le">
                <span data-key="subnet_mask">子网掩码：</span>
            </div>
            <div class="mid">
                <input type="text" class="form-control" id="netmask">
            </div>
            <div class="clear"></div>
        </div>
        <div class="line" style="display:none">
            <div class="clear"></div>
            <div class="le">
                <span data-key="enable_dhcp">DHCP开启：</span>
            </div>
            <div class="mid">
                <!-- <label> -->
                <input type="checkbox" id="dhcp_switch" checked onclick="fn()">
                <!-- </label> -->
            </div>
            <div class="clear"></div>
        </div>
        <div id="dhcpcont">
            <div class="line">
                <div class="clear"></div>
                <div class="le">
                    <span data-key="start_address">起始地址：</span>
                </div>
                <div class="mid">
                    <input type="text" id="start_addr" class="form-control">
                </div>
                <div class="clear"></div>
            </div>
            <div class="line">
                <div class="clear"></div>
                <div class="le">
                    <span data-key="end_address">结束地址：</span>
                </div>
                <div class="mid">
                    <input type="text" id="end_addr" class="form-control">
                </div>
                <div class="clear"></div>
            </div>
            <div class="line" style="display:none">
                <div class="clear"></div>
                <div class="le">
                    <span data-key="lease_time">租用时间：</span>
                </div>
                <div class="mid">
                    <input type="text" id="lease_time" class="form-control">
                </div>
                <div class="rig">
                    <span data-key="minute" class="hints">分钟</span>
                </div>
                <div class="clear"></div>
            </div>
            <div class="line" style="display:none">
                <div class="clear"></div>
                <div class="le">
                    <span>DHCP-OPTIONS：</span>
                </div>
                <div class="mid" id="inputPar">
                    <input type="text" class="form-control" id="dhcpoptions0">
                </div>
                <div class="rig" id="del"></div>
                <div class="clear"></div>
            </div>
            <div class="line" style="display:none">
                <div class="clear"></div>
                <div class="le"></div>
                <div class="mid">
                    <p data-key="formats" class="hints">格式：1,12.0.2.3</p>
                </div>
                <div class="rig">
                    <button data-key="add" class="btn btn-add" onclick="addOption('inputPar', 'del', 'dhcpoptions0')">增加</button>
                </div>
                <div class="clear"></div>
            </div>
        </div>
        <hr>
        <div class="notice">
            <p data-key="attention">&nbsp&nbsp&nbsp&nbsp注意：</p>
            <p data-key="lan_ip_alert">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp如果改变了LAN口的IP地址，您必须使用新的IP地址才能登陆路由器Web界面进行管理。</p>
        </div>
    </div>
</body>
<script>
function fn (){
    if (document.getElementById("dhcp_switch").checked) {
        document.getElementById("dhcpcont").style.display = "block";
    } else {
        document.getElementById("dhcpcont").style.display = "none";
    }
}

(function() {
    $.ajax({
        url: '../../cgi-bin/common.cgi?luaname=lan_interface&action=read',
        type: "GET",
        contentType: "application/json",
        dataType: 'json',
        success: function(data) {
            var obj = data.result;
            if (obj.code == 0) {
                console.log(obj);
                $("#ipaddr").val(obj.ipaddr);
                $("#netmask").val(obj.netmask);
                $("#dhcp_switch").prop("checked", parseInt(obj.enable));
                $("#start_addr").val(obj.start);
                $("#end_addr").val(obj.end);
                var time_min = (obj.leasetime == undefined ? "" : parseInt(obj.leasetime));
                $("#lease_time").val(time_min);
                if (obj.dhcp_option) {
                    var option = obj.dhcp_option + "";
                    var option_length = option.split(" ");
                    $("#inputPar").html("");
                    $("#del").html("");
                    $("#inputPar").append('<input type="text" class="form-control" id="dhcpoptions0">');
                    for (var i = 0; i < option_length.length; i++) {
                        var m = i + 1;
                        $("#dhcpoptions0").before('<input type="text" class="form-control" id="dhcpoption0' + m + '" value="' + option_length[i] + '">');
                        var k = i + 2;
                        $("#del").append('<button class="btn-danger btn" onclick="delOption(this,\'dhcpoption0\')" id="' + k + 'dels">删除2</button>');
                    };
                }
            } else {
                console.log("not code 0");
            }
        },
        error: function() {
            console.log(error);
        }
    })
})();

$("#Tsave").click(function() {
    var ipadd = $("#ipaddr").val(),
        netmask = $("#netmask").val(),
        dhcp_enable,
        start_addr = $("#start_addr").val(),
        end_addr = $("#end_addr").val(),
        leasetime = $("#lease_time").val(),
        dhcp_option = "",
        leasetime_ = "",
        url = "";
        leasetime_ = (leasetime == "") ? "" : (leasetime + "m");
    if ($("#dhcp_switch").prop("checked") == true) {
        dhcp_enable = 1;
    } else {
        dhcp_enable = 0;
    };
    var dhcp_lgh = $("#inputPar input");
    for (var i = 0; i < dhcp_lgh.length; i++) {
        dhcp_option = dhcp_option + dhcp_lgh[i].value + " ";
    };
    //数据校验
    if(ipadd=="" || netmask == ""){
        lang_alert('ip_mask_empty');
        return false;
    }
    if(!IsIp(ipadd)){
        lang_alert('ip_novalid');
        return false;
    }
    if(!IsMask(netmask)){
        lang_alert('ip_mask_novalid');
        return false;
    }
    if(dhcp_enable == 1){
        if(start_addr==""|| end_addr =="" || leasetime == "" || dhcp_option == ""){
            lang_alert('data_not_fully');
            return false;
        }
    }
    if(start_addr != "" && end_addr != ""){
        if(!IsIp(start_addr)){
            lang_alert('start_address_novalid');
            return false;
        }
        if(IsEqualIPAddress(ipadd,start_addr,netmask) == false){
            lang_alert('start_not_same_lan');
            return false;
        }
        if(!IsIp(end_addr)){
            lang_alert('end_address_novalid');
            return false;
        }
        if(IsEqualIPAddress(ipadd,end_addr,netmask) == false){
            lang_alert('end_not_same_lan');
            return false;
        }
        if(IptoNum(end_addr) < IptoNum(start_addr)){
            lang_alert('end_less_start');
            return false;
        }
    } 
    if( leasetime != "" && (!IsNum(leasetime) || leasetime<5 || leasetime>720)){
        lang_alert('lease_time_novalid');
        return false;
    }
    url = url_host + 'lan_interface&action=modify&ipaddr=' + ipadd + '&netmask=' + netmask + '&enable=' + dhcp_enable + '&start=' + start_addr + '&end=' + end_addr + '&leasetime=' + leasetime_ + '&dhcp_option=' + dhcp_option + url_time;
    check_code1(url);

})
</script>

</html>