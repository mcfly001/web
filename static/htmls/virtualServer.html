<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="../js/default.js"></script>
    <style>
    .dmz {
        display: inline-block;
        margin: 5px 5px 5px 0;
    }

    fieldset {
        margin: 10px 0;
    }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- <div class="choose_area">
            <ol class="ol_tag clear">
                <li><a href="#" class="selected">DMZ</a></li>
            </ol>
        </div>
        <fieldset>
            <div class="dmz"><span>DMZ</span></div>
            <div class="dmz">
                <input checked onclick="hideip()" name="switch" type="radio"><span>禁用</span></div>
            <div class="dmz">
                <input onclick="showip()" name="switch" type="radio"><span>启用</span></div>
            <div class="dmz ip" style="display: none;"><span>IP地址</span>
                <input type="text">
            </div>
            <input type="button" class="dmz" value="提交">
             </fieldset> -->
        <div class="choose_area">
            <ol class="ol_tag">
                <li><a data-key="port_map" href="#" class="selected">端口映射</a></li>
            </ol>
        </div>
        <div class="top-button">
            <button data-key="add" id="Tadd">添加</button>
        </div>
        <!-- 背景 -->
        <div class="div-bgd">
            <div class="div-bgd1">
                <div class="div-bgd2"></div>
            </div>
        </div>
        <div class="addf" id="addf">
            <div data-key="disable" id="addf-head" class="addf-head"><a href="#" class="close" id="close">关闭</a></div>
            <div class="addf-cont">
                <div class="addf-line">
                    <div class="clear"></div>
                    <label data-key="names" for="" class="addf-line-le">名字：</label>
                    <div class="addf-line-mid">
                        <input type="text" id="name" class="form-control">
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="addf-line">
                    <div class="clear"></div>
                    <label data-key="prefabricated_set" for="" class="addf-line-le">预制设置：</label>
                    <div class="addf-line-mid">
                        <select name="set" id="set">
                            <option data-key="please_choose" value="0" checked>请选择</option>
                            <option value="1">FTP(port:21)</option>
                            <option value="2">ISAKMP(port:500)</option>
                            <option value="3">Email(POP3)(port:110)</option>
                            <option value="4">Email(SMTP)(port:25)</option>
                            <option value="5">PPTP(port:1723)</option>
                            <option value="6">TELNET(port:23)</option>
                            <option value="7">WEB(http)(port:80)</option>
                        </select>
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="addf-line">
                    <div class="clear"></div>
                    <label data-key="external_port" for="" class="addf-line-le">外部端口：</label>
                    <div class="addf-line-mid">
                        <input type="text" id="src_dport" class="form-control">
                    </div>
                    <div class="addf-line-rig">
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="addf-line">
                    <div class="clear"></div>
                    <div class="nextLineHints">
                        <span data-key="port_use_split" class="hints">如果配置端口段请用-分割,例如：80-90</span>
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="addf-line">
                    <div class="clear"></div>
                    <label data-key="internal_port" for="" class="addf-line-le">内部端口：</label>
                    <div class="addf-line-mid">
                        <input type="text" id="dest_port" class="form-control">
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="addf-line">
                    <div class="clear"></div>
                    <div class="nextLineHints">
                        <span data-key="port_use_split" class="hints">如果配置端口段请用-分割,例如：80-90</span>
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="addf-line">
                    <div class="clear"></div>
                    <label data-key="internal_ipaddr" for="" class="addf-line-le">内部IP地址：</label>
                    <div class="addf-line-mid">
                        <input type="text" id="dest_ip" class="form-control">
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
            <div class="addf-foot">
                <button data-key="apply" class="sure">确定</button>
                <button data-key="cancle" class="cansel">取消</button>
            </div>
        </div>
        <table id="table" class="display" cellpadding="0" cellspacing="0">
            <thead>
                <tr class="tab-th">
                    <th data-key="number">序号</th>
                    <th data-key="name">名字</th>
                    <th data-key="prefabricatedset">预制设置</th>
                    <th data-key="externalport">外部端口</th>
                    <th data-key="internalport">内部端口</th>
                    <th data-key="internalipaddr">内部IP地址</th>
                    <th data-key="act">动作</th>
                </tr>
            </thead>
        </table>
    </div>
</body>
<script>
//dmz 单选切换效果
function showip() {
    $(".ip").css({
        "display": "inline-block"
    });
}

function hideip() {
    $(".ip").css({
        "display": "none"
    });
}

var real_data = {};
var index;
$(document).ready(function() {
    real_data = get_real_data("firewall_vserver"),
    count = 0,
    action = "";
    var table = $("#table").DataTable({
        "data": real_data,
        "columns": [
            {
                "data": null,
                "searchable": false,
                "orderable": false
            },
            {
                "data": "name",
                render: function(data, type, row, meta){
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": "set",
                render: function(data, type, row, meta){
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        switch (data) {
                            case "1":
                                return "FTP(port:21)";
                                break;
                            case "2":
                                return "ISAKMP(port:500)";
                                break;
                            case "3":
                                return "Email(POP3)(port:110)";
                                break;
                            case "4":
                                return "Email(SMTP)(port:25)";
                                break;
                            case "5":
                                return "PPTP(port:1723)";
                                break;
                            case "6":
                                return "TELNET(port:23)";
                                break;
                            case "7":
                                return "WEB(http)(port:80)";
                                break;
                            default:
                                return allResources['please_choose'][g_lang];
                                break;
                        }
                    }
                }
            },
            {
                "data": "src_dport",
                render: function(data, type, row, meta){
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": "dest_port",
                render: function(data, type, row, meta){
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": "dest_ip",
                render: function(data, type, row, meta){
                    if (data == undefined) {
                        return '<span>' + "" + '</span>'
                    } else {
                        return data;
                    }
                }
            },
            {
                "data": null,
                "searchable": false,
                "orderable": false,
                render: function() {
                    count++;
                    return '<th><a href="#" class="edit ' + count + 'tn">' + allResources['modify'][g_lang] + '</a> | <a href="#" class="delete">' + allResources['delete'][g_lang] + '</a></th>'
                }
            }
        ],
        "lengthMenu": [10, 30],
        "pagingType": "full_numbers",
        "order": [1, "asc"],
        'fnDrawCallback': function(table) {
            var newnode = creGoPage("changePage1", "dataTable-btn-1");

            document.getElementById("table_paginate").appendChild(newnode);
            var ootable = $("#table").dataTable();
            $('#dataTable-btn-1').click(function(e) {
                if ($("#changePage1").val() && $("#changePage1").val() > 0) {
                    console.log($("#changePage1").val());
                    var redirectpage = $("#changePage1").val() - 1;
                } else {
                    var redirectpage = 0;
                }
                ootable.fnPageChange(redirectpage);
            });
        },
        language: { //多语言
            "url": lang_url
        },
        "dom": "lftip"

    });
    //序号列
    table.on('order.dt search.dt',
        function() {
            table.column(0, {
                search: 'applied',
                order: 'applied'
            }).nodes().each(function(cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();
    //弹窗
    function showAddf(name, set, src_dport, dest_port, dest_ip){
        showDiv([".addf", ".div-bgd"]);
        $("#name").val(name);
        $("#set").val(set);
        $("#src_dport").val(src_dport);
        $("#dest_port").val(dest_port);
        $("#dest_ip").val(dest_ip);
    }

    //edit
    $("#table").on("click", ".edit", function(){
        action = "modify";
        var data = table.row($(this).parents("tr")).data();
        var class_num = $(this).attr("class");
        index = parseInt(class_num.substr(4)) - 1;
        console.log("index :",index);
        showAddf(data.name, data.set, data.src_dport, data.dest_port, data.dest_ip);
        document.getElementById("name").disabled = true;
    })
    
    //add
    $("#Tadd").click(function(){
        action = "add";
        document.getElementById("name").disabled = false;
        showAddf();
        $("#set").val("0");
    });

    //submit
    $(".sure").click(function(){
        var name = $("#name").val(),
            set = $("#set").val(),
            src_dport = $("#src_dport").val(),
            dest_dport = $("#dest_port").val(),
            dest_ip = $("#dest_ip").val();
        //数据校验
        if(name == "" || src_dport == "" || dest_dport == "" || dest_ip == "") {
            lang_alert('conf_all');
            return false;
        }
        if(!IsName(name)){
            lang_alert('name_novalid');
            return false;
        }
        if(action == "modify"){
            for(var i=0;i<real_data.length;i++){
                if(i==index) continue;
                if(real_data[i].name == name){
                    lang_alert('name_novalid');
                    return false;
                }
            }
        }else{
            for(var i=0;i<real_data.length;i++){
                if(real_data[i].name == name){
                    lang_alert('name_exist');
                    return false;
                }
            }
        }
        if(src_dport.indexOf("-") == -1){
            if(!IsNum(src_dport) || src_dport == 0 || src_dport>65535){
                lang_alert('external_port_err1');
                return false;
            }
        }else{
            var res = src_dport.split("-");
            if(!IsNum(res[0]) || res[0] == 0){
                lang_alert('external_port_err2');
                return false;
            }
            if(!IsNum(res[1]) || res[1] == 0){
                lang_alert('external_port_err2');
                return false;
            }
            if((res[1] - res[0]) < 0){
                lang_alert('external_port_err3');
                return false;
            }
        }
       
        if(dest_dport.indexOf("-") == -1){
            if(!IsNum(dest_dport) || dest_dport == 0 || dest_dport>65535)
            {
                lang_alert('internal_port_err1');
                return false;
            }
        }else{
            var res = dest_dport.split("-");
            if(!IsNum(res[0]) || res[0] == 0)
            {
                lang_alert('internal_port_err2');
                return false;
            }
            if(!IsNum(res[1]) || res[1] == 0)
            {
                lang_alert('internal_port_err2');
                return false;
            }
            if((res[1] - res[0]) < 0){
                lang_alert('internal_port_err3');
                return false;
            }
        }
        if((src_dport.indexOf("-") != -1) || (dest_dport.indexOf("-") != -1))
         { 
            var res1 = src_dport.split("-"); 
            var res2 = dest_dport.split("-");
            if((res1[0] > 65535)||(res1[1] > 65535)||(res2[0] > 65535)||(res2[1] > 65535))
            {
                lang_alert('port_err1');
                return false; 
            }
        } 
        if(IsIp(dest_ip) == false){
            lang_alert('internal_ipaddr_novalid');
            return false;
        }
        var url = url_host + "firewall_vserver&action=" + action + "&name=" + name + "&set=" + set + "&src_dport=" + src_dport + "&dest_port=" + dest_dport + "&dest_ip=" + dest_ip + url_time;
        console.log(url);
        check_code0(url);
    });

    //delete
    $("#table").on("click", ".delete", function(){
        action = "delete";
        var data = table.row($(this).parents("tr")).data(),
            name = data.name;
        url = url_host + "firewall_vserver&action=" + action + "&name=" + name + url_time;
        check_code0(url);
    })
});
</script>
</html>
